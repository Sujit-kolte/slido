<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 900px;
        margin: auto;
      }
      h1 {
        margin-bottom: 20px;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
      }
      button {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .btn-blue {
        background: #2563eb;
        color: white;
      }
      .btn-green {
        background: #059669;
        color: white;
      }
      .btn-red {
        background: #dc2626;
        color: white;
      }
      .btn-grey {
        background: #e5e7eb;
      }
      .session-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .badge {
        padding: 3px 8px;
        font-size: 12px;
        border-radius: 5px;
        margin-left: 10px;
      }
      .WAITING {
        background: #fde68a;
      }
      .ACTIVE {
        background: #bbf7d0;
      }
      .COMPLETED {
        background: #e5e7eb;
      }
      .option-row {
        display: flex;
        gap: 10px;
        margin-bottom: 6px;
      }
      .question-box {
        border: 1px solid #e5e7eb;
        padding: 10px;
        margin-bottom: 8px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>üõ† Admin Dashboard</h1>

      <div class="card">
        <h3>Create Session</h3>
        <input id="cTitle" placeholder="Session Title" />
        <input id="cCode" placeholder="Session Code" />
        <button class="btn-blue" onclick="createSession()">Create</button>
        <p id="createMsg"></p>
      </div>

      <div class="card">
        <h3>Manage Sessions</h3>
        <div id="sessionList">Loading‚Ä¶</div>
      </div>

      <div class="card" id="qManager" style="display: none">
        <h3>Questions for <span id="targetCodeDisplay"></span></h3>
        <input type="hidden" id="targetCode" />
        <input id="qText" placeholder="Question text" />
        <div id="optionsContainer"></div>
        <button class="btn-grey" onclick="addOptionUI()">+ Option</button>
        <br /><br />
        <button id="saveBtn" class="btn-blue" onclick="saveQuestion()">
          Save Question
        </button>
        <button
          id="cancelEditBtn"
          class="btn-red"
          style="display: none; margin-left: 10px"
          onclick="resetForm()">
          Cancel
        </button>
        <p id="qMsg"></p>
        <hr />
        <h4>Existing Questions</h4>
        <div id="existingQuestions"></div>
      </div>
    </div>

    <script>
      const API_URL = "https://slido-9mg1.onrender.com/api";
      const PASSCODE = sessionStorage.getItem("ADMIN_PASSCODE");
      const socket = io("https://slido-9mg1.onrender.com");

      // TRACKING STATE
      let currentSessionCode = null;
      let editingQuestionId = null;
      let loadedQuestions = []; // Store questions here to prevent HTML errors

      if (!PASSCODE) {
        alert("Login first");
        location.href = "admin.html";
      }

      /* SOCKET CONNECTION */
      socket.on("connect", () => {
        console.log("üü¢ Admin socket connected");
      });

      /* ============================
   1. SESSION MANAGEMENT
============================ */
      async function loadSessions() {
        try {
          const res = await fetch(`${API_URL}/sessions`);
          const data = await res.json();
          const list = document.getElementById("sessionList");
          list.innerHTML = "";

          if (!data.data || data.data.length === 0) {
            list.innerHTML = "<p>No sessions found. Create one above.</p>";
            return;
          }

          data.data.forEach((s) => {
            const div = document.createElement("div");
            div.className = "session-row";
            div.innerHTML = `
        <div>
          <b>${s.title}</b> (${s.sessionCode})
          <span class="badge ${s.status}">${s.status}</span>
        </div>
        <div>
          <button class="btn-grey" onclick="openQManager('${s.sessionCode}')">Questions</button>
          <button class="btn-green" onclick="startSession('${s._id}', '${s.sessionCode}')">Start</button>
          <button class="btn-red" onclick="stopSession('${s._id}')">Stop</button>
        </div>
      `;
            list.appendChild(div);
          });
        } catch (e) {
          console.error(e);
        }
      }

      async function createSession() {
        const title = document.getElementById("cTitle").value;
        const code = document.getElementById("cCode").value;
        if (!title || !code) return alert("Please fill all fields");

        await fetch(`${API_URL}/sessions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ title, sessionCode: code }),
        });
        loadSessions();
      }

      async function startSession(id, code) {
        if (!confirm("Start quiz?")) return;
        await fetch(`${API_URL}/sessions/${id}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ status: "ACTIVE" }),
        });
        setTimeout(() => {
          socket.emit("admin:start_game", code);
        }, 300);
        sessionStorage.setItem("SESSION_CODE", code);
        window.open("leaderboard.html", "_blank");
        loadSessions();
      }

      async function stopSession(id) {
        if (!confirm("Stop session?")) return;
        await fetch(`${API_URL}/sessions/${id}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ status: "COMPLETED" }),
        });
        loadSessions();
      }

      /* ============================
   2. QUESTION MANAGER
============================ */
      function openQManager(sessionCode) {
        currentSessionCode = sessionCode;
        document.getElementById("qManager").style.display = "block";
        document.getElementById("targetCodeDisplay").innerText = sessionCode;
        document.getElementById("targetCode").value = sessionCode;
        resetForm();
        fetchQuestions(sessionCode);
        document
          .getElementById("qManager")
          .scrollIntoView({ behavior: "smooth" });
      }

      function resetForm() {
        editingQuestionId = null;
        document.getElementById("qText").value = "";
        document.getElementById("optionsContainer").innerHTML = "";
        document.getElementById("saveBtn").innerText = "Save Question";
        document.getElementById("cancelEditBtn").style.display = "none";
        addOptionUI("", true);
        addOptionUI("", false);
      }

      function addOptionUI(text = "", correct = false) {
        const container = document.getElementById("optionsContainer");
        const div = document.createElement("div");
        div.className = "option-row";
        div.innerHTML = `
    <input type="radio" name="correctGroup" ${correct ? "checked" : ""}>
    <input class="opt-text" placeholder="Option text" value="${text}">
    <button class="btn-red" style="padding:4px 8px; margin:0;" onclick="this.parentElement.remove()">X</button>
  `;
        container.appendChild(div);
      }

      /* ============================
   3. SAVE / UPDATE LOGIC
============================ */
      async function saveQuestion() {
        const qText = document.getElementById("qText").value;
        const optRows = document.querySelectorAll(".option-row");

        const options = [];
        optRows.forEach((row) => {
          const text = row.querySelector(".opt-text").value;
          const isCorrect = row.querySelector("input[type=radio]").checked;
          if (text) options.push({ text, isCorrect });
        });

        if (!qText || options.length < 2)
          return alert("Need question + 2 options");
        if (!options.some((o) => o.isCorrect))
          return alert("Mark one correct option");

        const method = editingQuestionId ? "PUT" : "POST";
        const url = editingQuestionId
          ? `${API_URL}/questions/${editingQuestionId}`
          : `${API_URL}/questions`;

        const body = {
          sessionId: currentSessionCode,
          questionText: qText,
          options: options,
          marks: 10,
        };

        const res = await fetch(url, {
          method: method,
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify(body),
        });

        if (res.ok) {
          document.getElementById("qMsg").innerText = "Saved!";
          resetForm();
          fetchQuestions(currentSessionCode);
        } else {
          alert("Error saving");
        }
      }

      /* ============================
   4. LIST & ACTIONS (FIXED)
============================ */
      async function fetchQuestions(sessionCode) {
        const res = await fetch(`${API_URL}/questions/session/${sessionCode}`);
        const data = await res.json();
        const container = document.getElementById("existingQuestions");
        container.innerHTML = "";

        // 1. Save data globally to avoid JSON HTML errors
        loadedQuestions = data.data || [];

        if (loadedQuestions.length === 0) {
          container.innerHTML = "<i>No questions yet.</i>";
          return;
        }

        loadedQuestions.forEach((q, i) => {
          const div = document.createElement("div");
          div.className = "question-box";
          div.style.background = "#fff";
          div.style.padding = "10px";
          div.style.marginBottom = "10px";
          div.style.border = "1px solid #ddd";

          // 2. We use ID only in onclick to prevent quotes breaking HTML
          div.innerHTML = `
      <div style="display:flex; justify-content:space-between;">
        <strong>Q${i + 1}: ${q.questionText}</strong>
        <div>
          <button class="btn-grey" onclick="moveQuestion('${q._id}', 'up')">‚¨ÜÔ∏è</button>
          <button class="btn-grey" onclick="moveQuestion('${q._id}', 'down')">‚¨áÔ∏è</button>
          <button class="btn-blue" onclick="loadForEdit('${q._id}')">‚úèÔ∏è Edit</button>
          <button class="btn-red" onclick="deleteQuestion('${q._id}')">üóëÔ∏è</button>
        </div>
      </div>
      <ul style="margin:5px 0;">
        ${q.options.map((o) => `<li style="${o.isCorrect ? "color:green;font-weight:bold" : ""}">${o.text}</li>`).join("")}
      </ul>
    `;
          container.appendChild(div);
        });
      }

      // üü¢ NEW SAFE EDIT LOADER
      function loadForEdit(id) {
        // Find the question object from our global array
        const q = loadedQuestions.find((item) => item._id === id);
        if (!q) return;

        editingQuestionId = q._id;
        document.getElementById("qText").value = q.questionText;
        document.getElementById("optionsContainer").innerHTML = "";

        q.options.forEach((o) => addOptionUI(o.text, o.isCorrect));

        document.getElementById("saveBtn").innerText = "Update Question";
        document.getElementById("cancelEditBtn").style.display = "inline-block";
        document.getElementById("qManager").scrollIntoView();
      }

      async function moveQuestion(id, direction) {
        await fetch(`${API_URL}/questions/reorder/all`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ questionId: id, direction: direction }),
        });
        fetchQuestions(currentSessionCode);
      }

      async function deleteQuestion(id) {
        if (!confirm("Delete?")) return;
        await fetch(`${API_URL}/questions/${id}`, {
          method: "DELETE",
          headers: { "admin-passcode": PASSCODE },
        });
        fetchQuestions(currentSessionCode);
      }

      loadSessions();
    </script>
  </body>
</html>
