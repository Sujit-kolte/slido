<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <style>
      /* CSS STYLING */
      body {
        font-family: "Segoe UI", sans-serif;
        background-color: #f3f4f6;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
      }

      .container {
        width: 100%;
        max-width: 600px;
      }

      .card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1,
      h2 {
        margin-top: 0;
        color: #1f2937;
      }
      h2 {
        font-size: 18px;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-top: 15px;
        font-weight: bold;
        color: #4b5563;
        font-size: 14px;
      }

      input {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 16px;
      }

      /* Buttons */
      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
        transition: 0.2s;
        color: white;
      }

      .btn-start {
        background-color: #059669;
      } /* Green */
      .btn-stop {
        background-color: #dc2626;
        opacity: 0.6;
        cursor: not-allowed;
      } /* Red (Disabled initially) */

      .btn-save {
        background-color: #2563eb;
        width: 100%;
        margin-top: 20px;
      } /* Blue */
      .btn-add {
        background-color: #e5e7eb;
        color: #333;
        margin-top: 10px;
        width: auto;
        padding: 8px 15px;
        font-size: 14px;
      }

      button:hover {
        opacity: 0.9;
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Option Rows */
      .option-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-top: 10px;
      }
      .radio {
        width: 25px;
        height: 25px;
        cursor: pointer;
      }

      .status-msg {
        margin-top: 10px;
        font-weight: bold;
        font-size: 14px;
        text-align: center;
      }
      .success {
        color: green;
      }
      .error {
        color: red;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h2>Session Control</h2>
        <label>Session Code</label>
        <input
          type="text"
          id="sessionCode"
          placeholder="Enter Code (e.g. QUIZ-101)" />

        <div class="btn-group">
          <button class="btn-start" id="btnStart" onclick="startSession()">
            Start Session
          </button>
          <button
            class="btn-stop"
            id="btnStop"
            onclick="stopSession()"
            disabled>
            Stop Session
          </button>
        </div>
        <div id="sessionMsg" class="status-msg"></div>
      </div>

      <div class="card">
        <h2>Add Question</h2>

        <label>Question Text</label>
        <input type="text" id="qText" placeholder="Enter question here..." />

        <label>Options (Check the circle for correct answer)</label>
        <div id="options-list"></div>

        <button class="btn-add" onclick="addOptionUI()">+ Add Option</button>

        <button class="btn-save" onclick="saveQuestion()">Save Question</button>
        <div id="qMsg" class="status-msg"></div>
      </div>

      <div style="text-align: center">
        <a href="admin.html" style="color: #666">Logout</a>
      </div>
    </div>

    <script>
      // --- AUTH CHECK ---
      const ADMIN_PASSCODE = sessionStorage.getItem("ADMIN_PASSCODE");
      if (!ADMIN_PASSCODE) {
        alert("Please login first.");
        window.location.href = "admin.html";
      }

      // --- GLOBAL STATE ---
      let ACTIVE_SESSION_ID = null; // Stores DB ID (e.g. 64f123...)

      // --- INITIALIZE UI ---
      addOptionUI();
      addOptionUI();

      // --- LOGIC: START SESSION ---
      async function startSession() {
        const code = document.getElementById("sessionCode").value;
        const msg = document.getElementById("sessionMsg");
        const btnStart = document.getElementById("btnStart");
        const btnStop = document.getElementById("btnStop");

        if (!code) return (msg.innerText = "Please enter a Session Code");
        msg.innerText = "Starting...";

        try {
          const res = await fetch("http://localhost:5000/api/sessions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "admin-passcode": ADMIN_PASSCODE,
            },
            body: JSON.stringify({
              sessionCode: code,
              title: "Live Quiz", // Default title since input is hidden
            }),
          });

          const data = await res.json();

          if (res.ok) {
            // SUCCESS: Save ID and update UI
            ACTIVE_SESSION_ID = data.data._id; // Get ID from backend response

            msg.innerText = `Session '${code}' Started!`;
            msg.className = "status-msg success";

            // Disable Start, Enable Stop
            btnStart.disabled = true;
            btnStop.disabled = false;
            btnStop.style.opacity = "1";
            btnStop.style.cursor = "pointer";
            document.getElementById("sessionCode").disabled = true;
          } else {
            msg.innerText = "❌ " + (data.message || "Failed to start");
            msg.className = "status-msg error";
          }
        } catch (e) {
          msg.innerText = "Server Error";
          msg.className = "status-msg error";
        }
      }

      // --- LOGIC: STOP SESSION ---
      async function stopSession() {
        const msg = document.getElementById("sessionMsg");
        const btnStart = document.getElementById("btnStart");
        const btnStop = document.getElementById("btnStop");

        if (!ACTIVE_SESSION_ID) return; // Safety check

        msg.innerText = "Stopping...";

        try {
          // Call DELETE API with the ID
          const res = await fetch(
            `http://localhost:5000/api/sessions/${ACTIVE_SESSION_ID}`,
            {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                "admin-passcode": ADMIN_PASSCODE,
              },
            },
          );

          if (res.ok) {
            msg.innerText = "Session Stopped & Ended.";
            msg.className = "status-msg error";

            // Reset UI
            ACTIVE_SESSION_ID = null;
            btnStart.disabled = false;
            btnStop.disabled = true;
            btnStop.style.opacity = "0.6";
            document.getElementById("sessionCode").disabled = false;
          } else {
            msg.innerText = "Failed to stop session.";
          }
        } catch (e) {
          msg.innerText = "Network Error";
        }
      }

      // --- LOGIC: OPTIONS UI ---
      function addOptionUI() {
        const list = document.getElementById("options-list");
        const idx = list.children.length;

        const div = document.createElement("div");
        div.className = "option-row";
        div.innerHTML = `
            <input type="radio" name="correct" class="radio" value="${idx}">
            <input type="text" class="opt-text" placeholder="Option ${idx + 1}">
        `;
        list.appendChild(div);
      }

      // --- LOGIC: SAVE QUESTION ---
      async function saveQuestion() {
        const sessionCode = document.getElementById("sessionCode").value;
        const qText = document.getElementById("qText").value;
        const msg = document.getElementById("qMsg");

        // Validation
        if (!sessionCode)
          return (msg.innerText = "Error: Enter Session Code above.");
        if (!qText) return (msg.innerText = "Error: Enter Question Text.");

        // Gather Options
        const optRows = document.querySelectorAll(".option-row");
        let options = [];
        let correctIdx = -1;

        optRows.forEach((row, i) => {
          const text = row.querySelector(".opt-text").value;
          const isCorrect = row.querySelector('input[type="radio"]').checked;
          if (isCorrect) correctIdx = i;
          if (text.trim()) options.push({ text: text, isCorrect: isCorrect });
        });

        if (options.length < 2 || correctIdx === -1) {
          return (msg.innerText =
            "Error: Add 2+ options & select correct answer.");
        }

        msg.innerText = "Saving...";

        try {
          const res = await fetch("http://localhost:5000/api/questions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "admin-passcode": ADMIN_PASSCODE,
            },
            body: JSON.stringify({
              sessionId: sessionCode, // Sending code as string
              questionText: qText,
              options: options,
              marks: 10,
            }),
          });

          const data = await res.json();

          if (res.ok) {
            msg.innerText = "✅ Saved to DB!";
            msg.className = "status-msg success";
            // Clear fields
            document.getElementById("qText").value = "";
            document
              .querySelectorAll(".opt-text")
              .forEach((el) => (el.value = ""));
            document
              .querySelectorAll('input[type="radio"]')
              .forEach((el) => (el.checked = false));
          } else {
            msg.innerText = "❌ " + (data.message || "Failed");
            msg.className = "status-msg error";
          }
        } catch (e) {
          msg.innerText = "Server Error. Is backend running?";
          msg.className = "status-msg error";
        }
      }
    </script>
  </body>
</html>
