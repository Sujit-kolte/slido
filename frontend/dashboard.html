<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #f3f4f6;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 950px;
        margin: auto;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        box-sizing: border-box;
      }
      button {
        padding: 8px 14px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        margin-right: 5px;
      }

      /* COLORS */
      .btn-blue {
        background: #2563eb;
        color: white;
      }
      .btn-green {
        background: #059669;
        color: white;
      }
      .btn-red {
        background: #dc2626;
        color: white;
      }
      .btn-purple {
        background: #9333ea;
        color: white;
      }
      .btn-orange {
        background: #f59e0b;
        color: white;
      }
      .btn-grey {
        background: #e5e7eb;
      }

      /* LAYOUTS */
      .session-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
      }
      .session-row:last-child {
        border-bottom: none;
      }
      .badge {
        padding: 3px 8px;
        font-size: 12px;
        border-radius: 5px;
        margin-left: 10px;
      }
      .WAITING {
        background: #fde68a;
      }
      .ACTIVE {
        background: #bbf7d0;
      }
      .COMPLETED {
        background: #e5e7eb;
      }

      .question-box {
        border: 1px solid #e5e7eb;
        padding: 15px;
        margin-bottom: 10px;
        background: #fff;
        border-radius: 8px;
      }
      .q-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }
      .option-row {
        display: flex;
        gap: 10px;
        margin-bottom: 6px;
        align-items: center;
      }

      /* MODAL */
      .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: #111827;
        margin: 15% auto;
        padding: 20px;
        width: 300px;
        border-radius: 15px;
        color: white;
        text-align: center;
      }
      .preview-option {
        background: #1f2937;
        padding: 10px;
        margin: 5px 0;
        border-radius: 8px;
        border: 1px solid #374151;
        text-align: left;
      }
      .close {
        float: right;
        font-size: 28px;
        cursor: pointer;
        color: #ccc;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h1>üõ† Admin Dashboard</h1>

      <div class="card">
        <h3>Create New Session</h3>
        <input id="cTitle" placeholder="Session Title (e.g. JS Quiz)" />
        <input id="cCode" placeholder="Session Code (e.g. QUIZ101)" />
        <button class="btn-blue" onclick="createSession()">Create</button>
      </div>

      <div class="card">
        <h3>Manage Sessions</h3>
        <div id="sessionList">Loading...</div>
      </div>

      <div class="card" id="qManager" style="display: none">
        <h3>
          Questions for
          <span id="targetCodeDisplay" style="color: #2563eb"></span>
        </h3>

        <div
          style="
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
          ">
          <input
            id="qText"
            placeholder="Enter Question Text..."
            style="font-weight: bold" />
          <div id="optionsContainer"></div>
          <button class="btn-grey" onclick="addOptionUI()">+ Add Option</button>
          <div style="margin-top: 15px">
            <button id="saveBtn" class="btn-blue" onclick="saveQuestion()">
              Save Question
            </button>
            <button
              id="cancelEditBtn"
              class="btn-red"
              style="display: none"
              onclick="resetForm()">
              Cancel Edit
            </button>
          </div>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee" />
        <div id="existingQuestions"></div>
      </div>
    </div>

    <div id="previewModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closePreview()">&times;</span>
        <h3 style="color: #60a5fa">Mobile Preview</h3>
        <div
          id="previewText"
          style="font-size: 18px; margin-bottom: 20px"></div>
        <div id="previewOptions"></div>
      </div>
    </div>

    <script>
      // üü¢ UPDATE THIS URL TO YOUR RENDER URL
      const API_URL = "https://gdg-quiz-app.onrender.com/api";
      const PASSCODE = sessionStorage.getItem("ADMIN_PASSCODE");
      const socket = io("https://gdg-quiz-app.onrender.com");

      let currentSessionCode = null;
      let editingQuestionId = null;
      let loadedQuestions = [];

      if (!PASSCODE) {
        alert("Login first");
        location.href = "admin.html";
      }

      socket.on("connect", () => console.log("üü¢ Admin Connected"));

      /* ================= SESSIONS ================= */
      async function loadSessions() {
        const res = await fetch(`${API_URL}/sessions`);
        const data = await res.json();
        const list = document.getElementById("sessionList");
        list.innerHTML = "";

        if (!data.data || data.data.length === 0) {
          list.innerHTML = "<p>No sessions found.</p>";
          return;
        }

        data.data.forEach((s) => {
          const div = document.createElement("div");
          div.className = "session-row";
          div.innerHTML = `
      <div>
        <div style="font-size:16px; font-weight:bold;">${s.title}</div>
        <div style="font-size:13px; color:#666;">Code: ${s.sessionCode} <span class="badge ${s.status}">${s.status}</span></div>
      </div>
      <div>
        <button class="btn-grey" onclick="openQManager('${s.sessionCode}')">Questions</button>
        <button class="btn-green" onclick="startSession('${s._id}', '${s.sessionCode}')">Start</button>
        <button class="btn-orange" onclick="stopSession('${s._id}')">Stop</button>
        
        <button class="btn-purple" onclick="resetSession('${s._id}')" title="Reset Users & Scores">‚ôªÔ∏è</button>
        <button class="btn-red" onclick="deleteSession('${s.sessionCode}')" title="Delete Session">üóëÔ∏è</button>
      </div>
    `;
          list.appendChild(div);
        });
      }

      async function createSession() {
        const title = document.getElementById("cTitle").value;
        const code = document.getElementById("cCode").value;
        await fetch(`${API_URL}/sessions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ title, sessionCode: code }),
        });
        loadSessions();
        document.getElementById("cTitle").value = "";
        document.getElementById("cCode").value = "";
      }

      async function startSession(id, code) {
        if (!confirm("Start quiz?")) return;
        await fetch(`${API_URL}/sessions/${id}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ status: "ACTIVE" }),
        });
        setTimeout(() => socket.emit("admin:start_game", code), 300);
        sessionStorage.setItem("SESSION_CODE", code);
        window.open("leaderboard.html", "_blank");
        loadSessions();
      }

      async function stopSession(id) {
        if (!confirm("Stop session?")) return;
        await fetch(`${API_URL}/sessions/${id}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ status: "COMPLETED" }),
        });
        loadSessions();
      }

      async function resetSession(id) {
        if (
          !confirm(
            "‚ö†Ô∏è RESET SESSION?\n\nThis will DELETE all users and scores for this session so you can play again.\n\nThe questions will remain.",
          )
        )
          return;
        await fetch(`${API_URL}/sessions/${id}/data`, {
          method: "DELETE",
          headers: { "admin-passcode": PASSCODE },
        });
        alert("Session data cleared! Players can join again.");
        loadSessions();
      }

   async function deleteSession(sessionCode) {
  const confirmDelete = confirm(
    "‚ö†Ô∏è PERMANENT DELETE WARNING ‚ö†Ô∏è\n\n" +
      "This will delete:\n" +
      "- The Session\n" +
      "- All Questions\n" +
      "- All Participants\n" +
      "- All Responses\n\n" +
      "Are you sure?"
  );

  if (!confirmDelete) return;

  try {
    const res = await fetch(
`${API_URL}/sessions/code/${sessionCode}/permanent`
,
      {
        method: "DELETE",
        headers: {
          "admin-passcode": PASSCODE,
        },
      }
    );

    const data = await res.json();

    if (data.success) {
      alert("‚úÖ DELETED: " + data.message);
      loadSessions();
    } else {
      alert("‚ùå Error: " + data.message);
    }
  } catch (err) {
    console.error(err);
    alert("‚ùå Network Error: Could not delete session.");
  }
}

      /* ================= QUESTION MANAGER ================= */
      function openQManager(sessionCode) {
        currentSessionCode = sessionCode;
        document.getElementById("qManager").style.display = "block";
        document.getElementById("targetCodeDisplay").innerText = sessionCode;
        resetForm();
        fetchQuestions(sessionCode);
        document
          .getElementById("qManager")
          .scrollIntoView({ behavior: "smooth" });
      }

      function resetForm() {
        editingQuestionId = null;
        document.getElementById("qText").value = "";
        document.getElementById("optionsContainer").innerHTML = "";
        document.getElementById("saveBtn").innerText = "Save Question";
        document.getElementById("cancelEditBtn").style.display = "none";
        addOptionUI("", true);
        addOptionUI("", false);
      }

      function addOptionUI(text = "", correct = false) {
        const container = document.getElementById("optionsContainer");
        const div = document.createElement("div");
        div.className = "option-row";
        div.innerHTML = `
    <input type="radio" name="correctGroup" ${correct ? "checked" : ""} style="width:20px;">
    <input class="opt-text" placeholder="Option Answer" value="${text}">
    <button class="btn-red" style="padding:4px 8px;" onclick="this.parentElement.remove()">‚úï</button>
  `;
        container.appendChild(div);
      }

      async function saveQuestion() {
        const qText = document.getElementById("qText").value;
        const optRows = document.querySelectorAll(".option-row");
        const options = [];
        optRows.forEach((row) => {
          const text = row.querySelector(".opt-text").value;
          const isCorrect = row.querySelector("input[type=radio]").checked;
          if (text) options.push({ text, isCorrect });
        });

        if (!qText || options.length < 2)
          return alert("Need Question + 2 Options");
        if (!options.some((o) => o.isCorrect))
          return alert("Select Correct Answer");

        const method = editingQuestionId ? "PUT" : "POST";
        const url = editingQuestionId
          ? `${API_URL}/questions/${editingQuestionId}`
          : `${API_URL}/questions`;
        const body = {
          sessionId: currentSessionCode,
          questionText: qText,
          options,
          marks: 10,
        };

        await fetch(url, {
          method,
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify(body),
        });
        resetForm();
        fetchQuestions(currentSessionCode);
      }

      async function fetchQuestions(sessionCode) {
        const res = await fetch(`${API_URL}/questions/session/${sessionCode}`);
        const data = await res.json();
        loadedQuestions = data.data || [];
        const container = document.getElementById("existingQuestions");
        container.innerHTML = "";

        loadedQuestions.forEach((q, i) => {
          const div = document.createElement("div");
          div.className = "question-box";
          div.innerHTML = `
      <div class="q-header">
        <strong>Q${i + 1}: ${q.questionText}</strong>
        <div>
          <button class="btn-purple" title="Preview" onclick="previewQuestion('${q._id}')">üëÅÔ∏è</button>
          <button class="btn-grey" title="Move Up" onclick="moveQuestion('${q._id}', 'up')">‚¨ÜÔ∏è</button>
          <button class="btn-grey" title="Move Down" onclick="moveQuestion('${q._id}', 'down')">‚¨áÔ∏è</button>
          <button class="btn-blue" title="Edit" onclick="loadForEdit('${q._id}')">‚úèÔ∏è</button>
          <button class="btn-red" title="Delete" onclick="deleteQuestion('${q._id}')">üóëÔ∏è</button>
        </div>
      </div>
      <ul style="margin:0; padding-left:20px;">
        ${q.options.map((o) => `<li style="${o.isCorrect ? "color:#059669;font-weight:bold" : ""}">${o.text}</li>`).join("")}
      </ul>
    `;
          container.appendChild(div);
        });
      }

      function loadForEdit(id) {
        const q = loadedQuestions.find((item) => item._id === id);
        if (!q) return;
        editingQuestionId = q._id;
        document.getElementById("qText").value = q.questionText;
        document.getElementById("optionsContainer").innerHTML = "";
        q.options.forEach((o) => addOptionUI(o.text, o.isCorrect));
        document.getElementById("saveBtn").innerText = "Update Question";
        document.getElementById("cancelEditBtn").style.display = "inline-block";
        document.getElementById("qManager").scrollIntoView();
      }

      async function moveQuestion(id, dir) {
        await fetch(`${API_URL}/questions/reorder/all`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ questionId: id, direction: dir }),
        });
        fetchQuestions(currentSessionCode);
      }

    

      async function deleteQuestion(id) {
        if (!confirm("Delete?")) return;
        await fetch(`${API_URL}/questions/${id}`, {
          method: "DELETE",
          headers: { "admin-passcode": PASSCODE },
        });
        fetchQuestions(currentSessionCode);
      }

      function previewQuestion(id) {
        const q = loadedQuestions.find((item) => item._id === id);
        if (!q) return;
        document.getElementById("previewText").innerText = q.questionText;
        const optDiv = document.getElementById("previewOptions");
        optDiv.innerHTML = "";
        q.options.forEach((o) => {
          const d = document.createElement("div");
          d.className = "preview-option";
          d.innerText = o.text;
          if (o.isCorrect) d.style.borderColor = "#059669";
          optDiv.appendChild(d);
        });
        document.getElementById("previewModal").style.display = "block";
      }
      function closePreview() {
        document.getElementById("previewModal").style.display = "none";
      }
      loadSessions();
    </script>
  </body>
</html>
