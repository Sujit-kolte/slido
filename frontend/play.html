<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GDG Live Quiz</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #fbfbfc 0%, #7fbad1 80%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-image:
          linear-gradient(
            to right,
            rgba(8, 75, 162, 0.12) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(8, 75, 162, 0.12) 1px,
            transparent 1px
          );
        background-size: 40px 40px;
        overflow: hidden; /* Prevent scroll during game */
      }

      .container {
        max-width: 800px;
        width: 100%;
        position: relative;
      }

      .quiz-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border: 4px solid #1f2937;
        padding: 30px;
        position: relative;
        overflow: hidden;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      /* --- WAITING SCREEN --- */
      .waiting-screen {
        text-align: center;
        animation: fadeIn 1s ease forwards;
      }
      .pulse-text {
        animation: pulse 1.5s infinite;
        color: #2563eb;
        font-weight: bold;
      }
      @keyframes pulse {
        0% {
          opacity: 0.5;
        }
        50% {
          opacity: 1;
        }
        100% {
          opacity: 0.5;
        }
      }

      /* --- PLAYER BADGE --- */
      .player-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: #f3f4f6;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #4b5563;
        border: 1px solid #d1d5db;
        font-weight: 600;
        z-index: 10;
      }

      /* --- RANK BADGE --- */
      .rank-badge {
        position: absolute;
        top: 15px;
        left: 15px;
        background: #fffbeb;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        color: #d97706;
        border: 1px solid #fcd34d;
        font-weight: bold;
        z-index: 10;
        display: none; /* Hidden initially */
      }

      /* --- TIMER --- */
      .progress-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        margin-top: 20px;
      }

      .timer-circle-container {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto;
      }
      .timer-svg {
        transform: rotate(-90deg);
      }
      .timer-circle-bg {
        fill: none;
        stroke: #e0e0e0;
        stroke-width: 6;
      }
      .timer-circle-progress {
        fill: none;
        stroke: #2563eb;
        stroke-width: 6;
        stroke-linecap: round;
        stroke-dasharray: 251; /* 2 * PI * 40 */
        stroke-dashoffset: 0;
        transition: stroke-dashoffset 1s linear;
      }
      .timer-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 1.8em;
        font-weight: 700;
        color: #333;
      }

      /* --- QUESTION --- */
      .question-text {
        font-size: 1.4em;
        color: #333;
        margin: 20px 0 30px;
        font-weight: 600;
        text-align: center;
        line-height: 1.4;
      }

      /* --- OPTIONS (KBC STYLE) --- */
      .answers-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }
      .answer-btn {
        padding: 20px;
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        font-size: 1.1em;
        cursor: pointer;
        transition: 0.2s;
        text-align: left;
        position: relative;
        font-weight: 500;
        display: flex;
        align-items: center;
      }
      .answer-btn::before {
        content: attr(data-option);
        background: #2563eb;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 15px;
        font-size: 0.9em;
        font-weight: bold;
        flex-shrink: 0;
      }
      .answer-btn:hover {
        border-color: #2563eb;
        transform: translateY(-2px);
      }
      .answer-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* States */
      .answer-btn.selected {
        background: #eff6ff;
        border-color: #2563eb;
      }
      .answer-btn.correct {
        background: #dcfce7;
        border-color: #16a34a;
      }
      .answer-btn.wrong {
        background: #fee2e2;
        border-color: #dc2626;
      }

      /* --- OVERLAYS --- */
      .overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 50;
        text-align: center;
        display: none; /* Hidden by default */
      }
      .overlay.active {
        display: flex;
        animation: fadeIn 0.3s ease;
      }

      .result-title {
        font-size: 3em;
        margin-bottom: 10px;
        font-weight: 800;
      }
      .result-sub {
        font-size: 1.2em;
        color: #666;
      }

      /* --- GAME OVER --- */
      .game-over-container {
        text-align: center;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        padding: 10px;
      }
      .trophy {
        font-size: 4em;
        animation: bounce 2s infinite;
      }
      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .stats-row {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
      }
      .stat-box {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        flex: 1;
      }
      .stat-val {
        font-size: 1.5em;
        font-weight: bold;
        color: #2563eb;
      }
      .stat-lbl {
        font-size: 0.8em;
        color: #666;
        text-transform: uppercase;
      }

      .history-list {
        text-align: left;
        margin-top: 15px;
        max-height: 150px;
        overflow-y: auto;
      }
      .hist-item {
        font-size: 0.9em;
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
      }
      .hist-correct {
        color: #16a34a;
        font-weight: bold;
      }
      .hist-wrong {
        color: #dc2626;
        font-weight: bold;
      }

      .hidden {
        display: none !important;
      }

      /* Confetti */
      .confetti {
        position: absolute;
        width: 10px;
        height: 10px;
        animation: fall 2s linear forwards;
      }
      @keyframes fall {
        to {
          transform: translateY(100vh) rotate(360deg);
          opacity: 0;
        }
      }

      @media (max-width: 600px) {
        .answers-grid {
          grid-template-columns: 1fr;
        }
        .quiz-card {
          padding: 20px;
          min-height: 100vh;
          border: none;
          border-radius: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="quiz-card">
        <div id="playerInfo" class="player-badge">Player</div>
        <div id="rankBadge" class="rank-badge">Rank: --</div>

        <div id="waitingScreen" class="waiting-screen">
          <h1 style="font-size: 3em; margin-bottom: 20px">üéØ</h1>
          <h2 style="color: #1f2937; margin-bottom: 10px">
            Welcome to the Quiz!
          </h2>
          <p class="pulse-text">Waiting for host to start...</p>
          <div style="margin-top: 30px; font-size: 0.9em; color: #666">
            Get ready! The questions will appear here automatically.
          </div>
        </div>

        <div id="quizScreen" class="hidden">
          <div class="progress-info">
            <div style="font-weight: bold; color: #666" id="qCounter">Q1</div>
            <div class="timer-circle-container">
              <svg class="timer-svg" width="80" height="80">
                <circle class="timer-circle-bg" cx="40" cy="40" r="36"></circle>
                <circle
                  class="timer-circle-progress"
                  id="timerCircle"
                  cx="40"
                  cy="40"
                  r="36"></circle>
              </svg>
              <div class="timer-text" id="timerText">10</div>
            </div>
            <div style="font-weight: bold; color: #2563eb" id="scoreDisplay">
              0 pts
            </div>
          </div>

          <div class="question-text" id="questionText">Loading...</div>
          <div class="answers-grid" id="optionsGrid"></div>
        </div>

        <div id="resultOverlay" class="overlay">
          <div class="result-title" id="resTitle"></div>
          <div class="result-sub" id="resSub"></div>
          <div style="margin-top: 30px; font-size: 0.9em; color: #999">
            Next question coming soon...
          </div>
        </div>

        <div id="gameOverScreen" class="overlay">
          <div class="game-over-container">
            <div class="trophy">üèÜ</div>
            <h2 style="color: #1f2937; margin-bottom: 5px">Quiz Complete!</h2>

            <div style="margin: 20px 0">
              <div style="font-size: 0.9em; color: #666">YOUR FINAL RANK</div>
              <div
                style="font-size: 3em; font-weight: 800; color: #2563eb"
                id="finalRank">
                #--
              </div>
            </div>

            <div class="stats-row">
              <div class="stat-box">
                <div class="stat-val" style="color: #16a34a" id="statCorrect">
                  0
                </div>
                <div class="stat-lbl">Correct</div>
              </div>
              <div class="stat-box">
                <div class="stat-val" style="color: #dc2626" id="statWrong">
                  0
                </div>
                <div class="stat-lbl">Wrong</div>
              </div>
            </div>

            <div
              style="text-align: left; font-weight: bold; margin-bottom: 10px">
              Review:
            </div>
            <div class="history-list" id="historyList">
              <div>Loading history...</div>
            </div>

            <button
              onclick="location.href = 'user.html'"
              style="
                margin-top: 20px;
                padding: 12px 30px;
                background: #1f2937;
                color: white;
                border: none;
                border-radius: 30px;
                font-weight: bold;
                cursor: pointer;
                width: 100%;
              ">
              Exit Quiz
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // üü¢ AUTH & CONFIG
      const API_URL = "https://gdg-quiz-app.onrender.com";
      const SESSION_CODE =
        sessionStorage.getItem("SESSION_CODE") ||
        localStorage.getItem("SESSION_CODE");
      const PARTICIPANT_ID =
        sessionStorage.getItem("PARTICIPANT_ID") ||
        localStorage.getItem("PARTICIPANT_ID");
      const PLAYER_NAME =
        sessionStorage.getItem("PLAYER_NAME") ||
        localStorage.getItem("PLAYER_NAME");

      if (!SESSION_CODE || !PARTICIPANT_ID) {
        alert("Session lost. Please login.");
        window.location.href = "user.html";
      }

      if (PLAYER_NAME)
        document.getElementById("playerInfo").innerText = PLAYER_NAME;

      // üü¢ SOCKET SETUP
      const socket = io(API_URL, { transports: ["websocket"] });

      // State
      let currentQId = null;
      let timerInterval = null;
      let hasSubmitted = false;
      let myScore = 0;
      let myRank = "--";

      // --- SOCKET EVENTS ---

      socket.on("connect", () => {
        console.log("Connected");
        socket.emit("join:session", SESSION_CODE);
        socket.emit("sync:state", SESSION_CODE);
      });

      // 1. NEW QUESTION
      socket.on("game:question", (data) => {
        // Switch Views
        document.getElementById("waitingScreen").classList.add("hidden");
        document.getElementById("resultOverlay").classList.remove("active");
        document.getElementById("quizScreen").classList.remove("hidden");
        document.getElementById("rankBadge").style.display = "block"; // Show rank once game starts

        // Reset State
        currentQId = data.question._id;
        hasSubmitted = false;
        clearInterval(timerInterval);

        // Update UI
        document.getElementById("qCounter").innerText = data.qNum
          ? `Q${data.qNum}`
          : "Q";
        document.getElementById("questionText").innerText =
          data.question.questionText;

        // Render Options
        const grid = document.getElementById("optionsGrid");
        grid.innerHTML = "";
        const letters = ["A", "B", "C", "D"];

        data.question.options.forEach((opt, idx) => {
          const btn = document.createElement("button");
          btn.className = "answer-btn";
          btn.setAttribute("data-option", letters[idx]);
          btn.innerText = opt.text;
          btn.onclick = () => submitAnswer(opt.text, btn);
          grid.appendChild(btn);
        });

        // Start Timer
        startVisualTimer(data.time);
      });

      // 2. SHOW RESULT (Interstitial)
      socket.on("game:result", (data) => {
        const overlay = document.getElementById("resultOverlay");
        const title = document.getElementById("resTitle");
        const sub = document.getElementById("resSub");

        overlay.classList.add("active");

        const selectedBtn = document.querySelector(".answer-btn.selected");
        const myAnswer = selectedBtn ? selectedBtn.innerText : null;

        if (myAnswer === data.correctAnswer) {
          title.innerText = "üéâ Correct!";
          title.style.color = "#16a34a";
          sub.innerText = "+10 Points";
          confettiEffect();
        } else if (myAnswer) {
          title.innerText = "‚ùå Wrong";
          title.style.color = "#dc2626";
          sub.innerText = `Correct: ${data.correctAnswer}`;
        } else {
          title.innerText = "‚è∞ Time Up";
          title.style.color = "#d97706";
          sub.innerText = `Correct: ${data.correctAnswer}`;
        }
      });

      // 3. UPDATE RANKS
      socket.on("game:ranks", (ranks) => {
        const me = ranks.find((p) => p.id === PARTICIPANT_ID);
        if (me) {
          myRank = me.rank;
          myScore = me.score;
          document.getElementById("rankBadge").innerText = `Rank: #${myRank}`;
          document.getElementById("scoreDisplay").innerText = `${myScore} pts`;
        }
      });

      // 4. GAME OVER
      socket.on("game:over", async () => {
        document.getElementById("quizScreen").classList.add("hidden");
        document.getElementById("resultOverlay").classList.remove("active");
        document.getElementById("gameOverScreen").classList.add("active"); // Use overlay style

        document.getElementById("finalRank").innerText = `#${myRank}`;
        confettiEffect();

        // Fetch Stats
        try {
          const res = await fetch(
            `${API_URL}/api/participants/stats/${PARTICIPANT_ID}`,
          );
          const stats = await res.json();
          if (stats.success) {
            document.getElementById("statCorrect").innerText =
              stats.data.correct;
            document.getElementById("statWrong").innerText = stats.data.wrong;
          }
        } catch (e) {
          console.error(e);
        }

        // Fetch History
        try {
          const res = await fetch(
            `${API_URL}/api/participants/history/${PARTICIPANT_ID}`,
          );
          const hist = await res.json();
          const list = document.getElementById("historyList");
          list.innerHTML = "";

          hist.data.forEach((h, i) => {
            const div = document.createElement("div");
            div.className = "hist-item";
            const isCorrect = h.status === "CORRECT";
            div.innerHTML = `
                    <span>Q${i + 1}</span>
                    <span class="${isCorrect ? "hist-correct" : "hist-wrong"}">
                        ${isCorrect ? "Correct" : "Wrong"}
                    </span>
                `;
            list.appendChild(div);
          });
        } catch (e) {
          console.error(e);
        }
      });

      // --- ACTIONS ---

      async function submitAnswer(answer, btn) {
        if (hasSubmitted) return;
        hasSubmitted = true;

        // Visual Feedback
        document
          .querySelectorAll(".answer-btn")
          .forEach((b) => (b.disabled = true));
        btn.classList.add("selected");
        btn.style.borderColor = "#2563eb";
        btn.style.backgroundColor = "#eff6ff";

        // Logic
        const timeLeftVal = parseInt(
          document.getElementById("timerText").innerText,
        );

        try {
          await fetch(`${API_URL}/api/participants/submit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              participantId: PARTICIPANT_ID,
              questionId: currentQId,
              selectedOption: answer,
              timeLeft: timeLeftVal,
            }),
          });
        } catch (e) {
          console.error("Submit Error", e);
        }
      }

      // --- VISUALS ---

      function startVisualTimer(seconds) {
        const circle = document.getElementById("timerCircle");
        const text = document.getElementById("timerText");
        const circumference = 251; // 2 * PI * 40

        // Reset
        circle.style.transition = "none";
        circle.style.strokeDashoffset = 0;
        circle.style.stroke = "#2563eb";

        let timeLeft = seconds;
        text.innerText = timeLeft;

        // Force reflow
        void circle.offsetWidth;
        circle.style.transition = "stroke-dashoffset 1s linear";

        timerInterval = setInterval(() => {
          timeLeft--;
          text.innerText = timeLeft;

          // Calculate Offset
          const offset = circumference - (timeLeft / seconds) * circumference;
          circle.style.strokeDashoffset = -offset; // Negative to rotate correctly

          // Colors
          if (timeLeft <= 5) circle.style.stroke = "#f59e0b"; // Warning
          if (timeLeft <= 3) circle.style.stroke = "#dc2626"; // Danger

          if (timeLeft <= 0) clearInterval(timerInterval);
        }, 1000);
      }

      function confettiEffect() {
        const colors = ["#ff6b6b", "#4ecdc4", "#45b7d1", "#f9ca24", "#6c5ce7"];
        for (let i = 0; i < 30; i++) {
          const c = document.createElement("div");
          c.className = "confetti";
          c.style.left = Math.random() * 100 + "%";
          c.style.background =
            colors[Math.floor(Math.random() * colors.length)];
          document.body.appendChild(c);
          setTimeout(() => c.remove(), 2000);
        }
      }
    </script>
  </body>
</html>
