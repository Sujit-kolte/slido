<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>GDG Live Quiz</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #111827;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .container {
        width: 100%;
        max-width: 420px;
        padding: 20px;
        text-align: center;
      }
      .timer {
        font-size: 22px;
        font-weight: bold;
        color: #60a5fa;
        text-align: right;
      }
      .question {
        font-size: 24px;
        margin: 20px 0;
      }
      .option {
        width: 100%;
        padding: 16px;
        margin-bottom: 12px;
        background: #1f2937;
        border: 2px solid #374151;
        color: white;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        text-align: left;
        transition: 0.2s;
      }
      .option:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 50;
        text-align: center;
      }
      .hidden {
        display: none !important;
      }
      .rank-box {
        background: #374151;
        padding: 15px 30px;
        border-radius: 15px;
        border: 2px solid #fbbf24;
        margin-top: 20px;
        animation: popIn 0.5s ease;
      }

      /* üü¢ Rank Badge Style (Top Left) */
      #rankBadge {
        position: absolute;
        top: 20px;
        left: 20px;
        background: #374151;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: bold;
        color: #fbbf24;
        border: 1px solid #4b5563;
        transition: opacity 0.3s;
      }

      /* üü¢ Player Info Badge (Top Right) */
      #playerInfo {
        position: absolute;
        top: 20px;
        right: 20px;
        background: #1f2937;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 14px;
        color: #9ca3af;
        border: 1px solid #374151;
      }

      @keyframes popIn {
        from { transform: scale(0.5); opacity: 0; }
        to { transform: scale(1); opacity: 1; }
      }

      /* =========================================
         üü¢ NEW STYLES FOR GAME OVER SCREEN
      ========================================= */
      
      /* Winners Box */
      .winners-box {
        background: #1f2937;
        border: 1px solid #4b5563;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 20px;
        width: 100%;
      }
      .winner-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 5px;
        background: #374151;
        border-radius: 8px;
        font-weight: bold;
        font-size: 14px;
      }
      .rank-1 { border-left: 4px solid #fbbf24; color: #fbbf24; } /* Gold */
      .rank-2 { border-left: 4px solid #94a3b8; color: #94a3b8; } /* Silver */
      .rank-3 { border-left: 4px solid #b45309; color: #b45309; } /* Bronze */
      .w-score { color: #fff; font-size: 14px; }

      /* Stats Grid */
      .stats-grid {
        display: flex; 
        gap: 10px; 
        margin-bottom: 20px; 
        justify-content: center;
        width: 100%;
      }
      .stat-box {
        padding: 10px; 
        border-radius: 10px; 
        flex: 1;
        text-align: center;
      }

      /* History List */
      .history-container {
        max-height: 250px;
        overflow-y: auto;
        margin-top: 15px;
        width: 100%;
        text-align: left;
        padding-right: 5px;
      }
      .history-item {
        background: #374151;
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 8px;
        border-left: 5px solid #6b7280;
        font-size: 13px;
      }
      .status-CORRECT { border-left-color: #10b981; }
      .status-WRONG { border-left-color: #ef4444; }
      .status-TIMEOUT { border-left-color: #f59e0b; }
      
      .h-badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
        font-weight: bold;
        color: white;
        margin-bottom: 4px;
      }
      .bg-CORRECT { background: #10b981; }
      .bg-WRONG { background: #ef4444; }
      .bg-TIMEOUT { background: #f59e0b; }

    </style>
  </head>

  <body>
    <div id="rankBadge" class="hidden">Rank: --</div>
    <div id="playerInfo">Loading...</div>

    <div class="container" id="gameArea">
      <div class="timer" id="timer">--</div>
      <div class="question" id="questionText">Waiting for host‚Ä¶</div>
      <div id="options"></div>
    </div>

    <div class="overlay hidden" id="resultOverlay">
      <h1 id="resultTitle" style="font-size: 40px; margin: 0"></h1>
      <p id="correctAnswer" style="color: #9ca3af; margin-top: 10px"></p>

      <div id="rankContainer" class="hidden rank-box">
        <div style="color: #fbbf24; font-size: 14px; letter-spacing: 1px">
          CURRENT RANK
        </div>
        <div
          id="resultRank"
          style="color: white; font-size: 42px; font-weight: bold">
          #--
        </div>
      </div>

      <p style="opacity: 0.6; margin-top: 30px; font-size: 14px">
        Next question in <span id="coolTimer">5</span>...
      </p>
    </div>

    <div
      id="gameOverCard"
      class="hidden"
      style="
        position: fixed;
        inset: 0;
        background: #111827;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 100;
        padding: 20px;
        overflow-y: auto; 
      ">
      
      <div style="width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center;">
        
        <h1 style="color: #fbbf24; font-size: 32px; margin-bottom: 15px; margin-top: 0;">
          üèÜ Quiz Completed!
        </h1>

        <div id="winnersContainer" class="winners-box hidden">
          <h3 style="margin: 0 0 10px 0; color: white; text-align: center; font-size: 16px;">üéâ Top Winners</h3>
          <div id="winnersList"></div>
        </div>

        <div style="background: #1f2937; padding: 20px; border-radius: 15px; width: 100%; box-sizing: border-box; border: 1px solid #374151;">
          
          <div style="text-align: center; margin-bottom: 20px;">
            <p style="color: #9ca3af; margin: 0; font-size: 12px;">YOUR FINAL RANK</p>
            <h2 id="finalRankDisplay" style="font-size: 42px; margin: 5px 0; color: white">#--</h2>
            <p id="finalScoreDisplay" style="color: #34d399; font-weight: bold; font-size: 18px">0 pts</p>
          </div>

          <div class="stats-grid">
            <div class="stat-box" style="background: #059669;">
              <div style="font-size: 10px; opacity: 0.9;">CORRECT</div>
              <div id="statCorrect" style="font-size: 20px; font-weight: bold;">--</div>
            </div>
            <div class="stat-box" style="background: #dc2626;">
              <div style="font-size: 10px; opacity: 0.9;">WRONG</div>
              <div id="statWrong" style="font-size: 20px; font-weight: bold;">--</div>
            </div>
            <div class="stat-box" style="background: #d97706;">
              <div style="font-size: 10px; opacity: 0.9;">TIMEOUT</div>
              <div id="statTimeout" style="font-size: 20px; font-weight: bold;">--</div>
            </div>
          </div>

          <div style="border-top: 1px solid #4b5563; padding-top: 15px;">
            <h3 style="margin: 0; color: white; font-size: 16px;">Review Answers</h3>
            <div id="historyList" class="history-container">
              <div style="text-align:center; color:#9ca3af;">Loading review...</div>
            </div>
          </div>

        </div>

        <button
          onclick="location.href = 'user.html'"
          style="
            margin-top: 20px;
            padding: 12px 30px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
          ">
          Exit to Home
        </button>
      </div>
    </div>

    <script>
      let hasSubmitted = false;
      let currentQuestionId = null;
      let myCurrentRank = "--";
      let myCurrentScore = 0;

      const SESSION_CODE =
        localStorage.getItem("SESSION_CODE") ||
        sessionStorage.getItem("SESSION_CODE");
      const PARTICIPANT_ID =
        localStorage.getItem("PARTICIPANT_ID") ||
        sessionStorage.getItem("PARTICIPANT_ID");
      const PLAYER_NAME =
        localStorage.getItem("PLAYER_NAME") ||
        sessionStorage.getItem("PLAYER_NAME");
      const PLAYER_CODE =
        localStorage.getItem("PLAYER_CODE") ||
        sessionStorage.getItem("PLAYER_CODE");

      console.log("Login Check:", { SESSION_CODE, PARTICIPANT_ID });

      if (!SESSION_CODE || !PARTICIPANT_ID) {
        alert("Session expired. Please login again.");
        location.href = "user.html";
      }

      if (PLAYER_NAME) {
        document.getElementById("playerInfo").innerText = PLAYER_CODE
          ? `${PLAYER_NAME} (${PLAYER_CODE})`
          : PLAYER_NAME;
      }

      // ‚úÖ RENDER URL
      const API_URL = "https://gdg-quiz-app.onrender.com";

      const socket = io(API_URL, {
        transports: ["websocket"],
      });

      let timeLeft = 0,
        timerInterval = null,
        myAnswer = null;

      socket.on("connect", () => {
        console.log("Connected to Socket");
        socket.emit("join:session", SESSION_CODE);
        socket.emit("sync:state", SESSION_CODE);
      });

      socket.on("game:question", (data) => {
        currentQuestionId = data.question._id;

        document.getElementById("rankBadge").classList.add("hidden");
        document.getElementById("resultOverlay").classList.add("hidden");
        document.getElementById("rankContainer").classList.add("hidden");
        // Hide Game Over if previously shown
        document.getElementById("gameOverCard").classList.add("hidden");

        clearInterval(timerInterval);
        myAnswer = null;
        hasSubmitted = false;
        timeLeft = data.time;

        document.getElementById("questionText").innerText = data.qNum
          ? `Q${data.qNum}: ${data.question.questionText}`
          : data.question.questionText;

        const optionsDiv = document.getElementById("options");
        optionsDiv.innerHTML = "";

        data.question.options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.className = "option";
          btn.innerText = opt.text;
          btn.onclick = () => submitAnswer(opt.text, btn);
          optionsDiv.appendChild(btn);
        });
        startTimer();
      });

      async function submitAnswer(answer, btn) {
        if (hasSubmitted) return;
        hasSubmitted = true;
        document
          .querySelectorAll(".option")
          .forEach((b) => (b.disabled = true));
        btn.style.background = "#2563eb";
        myAnswer = answer;

        try {
          await fetch(`${API_URL}/api/participants/submit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              participantId: PARTICIPANT_ID,
              questionId: currentQuestionId,
              selectedOption: answer,
              timeLeft,
            }),
          });
        } catch (err) {
          console.error("Submit failed:", err);
        }
      }

      socket.on("game:result", (data) => {
        document.getElementById("resultOverlay").classList.remove("hidden");
        document.getElementById("correctAnswer").innerText =
          `Answer: ${data.correctAnswer}`;

        const title = document.getElementById("resultTitle");
        const myAnsNorm = myAnswer ? String(myAnswer).trim().toLowerCase() : "";
        const correctNorm = String(data.correctAnswer).trim().toLowerCase();

        if (myAnsNorm === correctNorm) {
          title.innerText = "üéâ Correct!";
          title.style.color = "#4ade80";
        } else if (myAnswer) {
          title.innerText = "‚ùå Wrong";
          title.style.color = "#ef4444";
        } else {
          title.innerText = "‚è∞ Time Up";
          title.style.color = "#fbbf24";
        }

        document.getElementById("rankBadge").classList.remove("hidden");

        let cool = 5;
        const coolEl = document.getElementById("coolTimer");
        const interval = setInterval(() => {
          cool--;
          coolEl.innerText = cool;
          if (cool <= 0) clearInterval(interval);
        }, 1000);
      });

      socket.on("game:ranks", (rankList) => {
        const myData = rankList.find(
          (p) => String(p.id) === String(PARTICIPANT_ID),
        );

        if (myData) {
          myCurrentRank = myData.rank;
          myCurrentScore = myData.score;

          document.getElementById("rankBadge").innerText =
            `Rank: #${myData.rank} (${myData.score} pts)`;

          document.getElementById("resultRank").innerText = `#${myData.rank}`;
          document.getElementById("rankContainer").classList.remove("hidden");
        }
      });

      // üü¢ GAME OVER LISTENER
      socket.on("game:over", async (data) => {
        document.getElementById("gameArea").style.display = "none";
        document.getElementById("resultOverlay").style.display = "none";
        document.getElementById("rankBadge").style.display = "none";

        // 1. Render Top 3 Winners
        if (data && data.winners && data.winners.length > 0) {
          const list = document.getElementById("winnersList");
          list.innerHTML = "";
          data.winners.forEach((p, index) => {
            const div = document.createElement("div");
            div.className = `winner-row rank-${index + 1}`;
            let medal = "ü•á";
            if(index === 1) medal = "ü•à";
            if(index === 2) medal = "ü•â";
            div.innerHTML = `<span>${medal} ${p.name}</span><span class="w-score">${p.totalScore} pts</span>`;
            list.appendChild(div);
          });
          document.getElementById("winnersContainer").classList.remove("hidden");
        }

        // 2. Local Rank
        document.getElementById("finalRankDisplay").innerText = `#${myCurrentRank}`;
        document.getElementById("finalScoreDisplay").innerText = `${myCurrentScore} pts`;

        // 3. Show Card
        document.getElementById("gameOverCard").classList.remove("hidden");

        // 4. Fetch Stats
        try {
          const res = await fetch(`${API_URL}/api/participants/stats/${PARTICIPANT_ID}`);
          const stats = await res.json();
          if (stats.success) {
            document.getElementById("statCorrect").innerText = stats.data.correct;
            document.getElementById("statWrong").innerText = stats.data.wrong;
            document.getElementById("statTimeout").innerText = stats.data.timeout;
          }
        } catch (e) { console.error("Stats error", e); }

        // 5. Fetch History
        const historyList = document.getElementById("historyList");
        try {
          const res = await fetch(`${API_URL}/api/participants/history/${PARTICIPANT_ID}`);
          const hist = await res.json();
          if (hist.success) {
            historyList.innerHTML = "";
            hist.data.forEach((item, index) => {
              const div = document.createElement("div");
              div.className = `history-item status-${item.status}`;
              div.innerHTML = `
                <div class="h-badge bg-${item.status}">${item.status}</div>
                <div style="font-weight:bold; margin-bottom:5px;">Q${index + 1}: ${item.questionText}</div>
                <div style="color: #9ca3af; font-size: 13px;">
                  Your Answer: <span style="color:white;">${item.userSelected}</span>
                </div>
                ${item.status !== "CORRECT" ? 
                  `<div style="color: #10b981; font-size: 13px;">Correct: <b>${item.correctAnswer}</b></div>` : ""}
              `;
              historyList.appendChild(div);
            });
          }
        } catch (e) { console.error("History error", e); }
      });

      function startTimer() {
        document.getElementById("timer").innerText = `${timeLeft}s`;
        timerInterval = setInterval(() => {
          timeLeft--;
          document.getElementById("timer").innerText = `${timeLeft}s`;
          if (timeLeft <= 0) clearInterval(timerInterval);
        }, 1000);
      }
    </script>
  </body>
</html>