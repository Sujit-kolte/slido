<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | GDG Quiz</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
      @import url("https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@300;400;500;700&display=swap");

      :root {
        --google-blue: #4285f4;
        --google-red: #ea4335;
        --google-yellow: #fbbc05;
        --google-green: #34a853;
        --white: #ffffff;
        --bg-light: #f8f9fa;
        --text-primary: #202124;
        --text-secondary: #5f6368;
        --border-light: #dadce0;
        --shadow-sm:
          0 1px 2px 0 rgba(60, 64, 67, 0.3),
          0 1px 3px 1px rgba(60, 64, 67, 0.15);
        --shadow-md:
          0 1px 3px 0 rgba(60, 64, 67, 0.3),
          0 4px 8px 3px rgba(60, 64, 67, 0.15);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Roboto", sans-serif;
        background: var(--bg-light);
        color: var(--text-primary);
        height: 100vh;
        overflow: hidden; /* Prevent full page scroll */
      }

      .layout {
        display: grid;
        grid-template-columns: 300px 1fr;
        height: 100vh;
      }

      /* --- SIDEBAR --- */
      .sidebar {
        background: var(--white);
        border-right: 1px solid var(--border-light);
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .sidebar-header {
        padding: 24px;
        border-bottom: 1px solid var(--border-light);
      }

      .logo {
        font-family: "Google Sans", sans-serif;
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(
          135deg,
          var(--google-blue),
          var(--google-green)
        );
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
      }

      .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
      }

      /* --- MAIN CONTENT --- */
      .main-content {
        padding: 32px 40px;
        overflow-y: auto;
        background-image:
          linear-gradient(
            to right,
            rgba(66, 133, 244, 0.05) 1px,
            transparent 1px
          ),
          linear-gradient(
            to bottom,
            rgba(66, 133, 244, 0.05) 1px,
            transparent 1px
          );
        background-size: 40px 40px;
      }

      /* --- STATS GRID --- */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: var(--white);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s;
      }
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .stat-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
      }
      .stat-card:nth-child(1)::before {
        background: var(--google-blue);
      }
      .stat-card:nth-child(2)::before {
        background: var(--google-green);
      }
      .stat-card:nth-child(3)::before {
        background: var(--google-yellow);
      }

      .stat-value {
        font-family: "Google Sans";
        font-size: 2rem;
        font-weight: 700;
        margin-top: 10px;
      }
      .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      /* --- CARDS & INPUTS --- */
      .card {
        background: var(--white);
        padding: 24px;
        border-radius: 16px;
        box-shadow: var(--shadow-sm);
        margin-bottom: 20px;
      }

      h2,
      h3 {
        font-family: "Google Sans";
        color: var(--text-primary);
        margin-bottom: 16px;
      }

      input {
        width: 100%;
        padding: 12px 16px;
        margin-bottom: 12px;
        border: 2px solid var(--border-light);
        border-radius: 8px;
        font-size: 0.95rem;
        transition: 0.2s;
        font-family: "Roboto", sans-serif;
      }
      input:focus {
        outline: none;
        border-color: var(--google-blue);
      }

      /* --- BUTTONS --- */
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.9rem;
        font-family: "Google Sans";
        transition: 0.2s;
      }
      button:hover {
        opacity: 0.9;
        transform: translateY(-1px);
      }
      button:disabled {
        background: #ccc !important;
        cursor: not-allowed;
      }

      .btn-blue {
        background: var(--google-blue);
        color: white;
      }
      .btn-green {
        background: var(--google-green);
        color: white;
      }
      .btn-red {
        background: var(--google-red);
        color: white;
      }
      .btn-grey {
        background: #e5e7eb;
        color: var(--text-primary);
      }

      /* --- SESSION LIST ITEMS --- */
      .session-item {
        padding: 16px;
        border: 1px solid var(--border-light);
        border-radius: 12px;
        margin-bottom: 12px;
        background: var(--white);
        transition: 0.2s;
      }
      .session-item:hover {
        border-color: var(--google-blue);
        box-shadow: var(--shadow-sm);
      }
      .session-item.active {
        border-left: 4px solid var(--google-green);
        background: #f0fdf4;
      }

      .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
      }
      .badge.WAITING {
        background: #fef3c7;
        color: #d97706;
      }
      .badge.ACTIVE {
        background: #dcfce7;
        color: #166534;
      }
      .badge.COMPLETED {
        background: #f3f4f6;
        color: #374151;
      }

      /* --- QUESTION MANAGER --- */
      .question-box {
        border: 1px solid var(--border-light);
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 12px;
        background: white;
      }
      .option-row {
        display: flex;
        gap: 10px;
        margin-bottom: 8px;
        align-items: center;
      }

      /* --- PLACEHOLDER --- */
      .empty-state {
        text-align: center;
        padding: 60px;
        color: var(--text-secondary);
      }
      .empty-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.3;
      }

      @media (max-width: 768px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .sidebar {
          display: none;
        } /* Hide sidebar on mobile for now */
      }
    </style>
  </head>

  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="logo">
            <div class="logo-icon">ðŸ› </div>
            <span>Admin Panel</span>
          </div>
        </div>

        <div class="sidebar-content">
          <div
            class="card"
            style="box-shadow: none; border: 1px solid var(--border-light)">
            <h3 style="font-size: 1rem">Create Session</h3>
            <input id="cTitle" placeholder="Title (e.g. JavaScript Quiz)" />
            <input
              id="cCode"
              placeholder="Code (e.g. JS101)"
              style="text-transform: uppercase" />
            <button
              class="btn-blue"
              style="width: 100%"
              onclick="createSession()">
              + New Session
            </button>
          </div>

          <h4
            style="
              margin: 20px 0 10px;
              color: var(--text-secondary);
              font-size: 0.85rem;
              text-transform: uppercase;
            ">
            Your Sessions
          </h4>
          <div id="sessionList">
            <div style="text-align: center; padding: 20px; color: #999">
              Loading...
            </div>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-value" id="statSessions">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Active Questions</div>
            <div class="stat-value" id="statQuestions">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">System Status</div>
            <div
              class="stat-value"
              style="font-size: 1.5rem; color: var(--google-green)">
              Online ðŸŸ¢
            </div>
          </div>
        </div>

        <div id="managerPlaceholder" class="empty-state">
          <div class="empty-icon">ðŸ‘ˆ</div>
          <h2>Select a Session</h2>
          <p>
            Choose a session from the sidebar to manage questions or start the
            game.
          </p>
        </div>

        <div id="qManager" style="display: none">
          <div class="card" style="border-top: 4px solid var(--google-blue)">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
              ">
              <div>
                <span style="color: var(--text-secondary); font-size: 0.9rem"
                  >Managing Session:</span
                >
                <h2 style="margin: 0; font-size: 1.8rem" id="targetCodeDisplay">
                  ...
                </h2>
              </div>
              <button class="btn-grey" onclick="closeManager()">
                Close Manager
              </button>
            </div>

            <div
              style="
                background: #f8fafc;
                padding: 20px;
                border-radius: 12px;
                border: 1px dashed var(--border-light);
              ">
              <h3 style="font-size: 1.1rem">Add New Question</h3>
              <input id="qText" placeholder="Type your question here..." />
              <div id="optionsContainer"></div>
              <button class="btn-grey" onclick="addOptionUI()">
                + Add Option
              </button>
              <div style="margin-top: 20px; text-align: right">
                <button class="btn-blue" onclick="saveQuestion()">
                  Save to Server
                </button>
              </div>
            </div>
          </div>

          <h3 style="margin-top: 30px">Existing Questions</h3>
          <div id="existingQuestions"></div>
        </div>
      </main>
    </div>

    <script>
      // ðŸŸ¢ CONFIGURATION
      const API_URL = "https://slido-9mg1.onrender.com/api";
      const SOCKET_URL = "https://slido-9mg1.onrender.com";

      // Auth Check
      const PASSCODE = sessionStorage.getItem("ADMIN_PASSCODE");
      if (!PASSCODE) window.location.href = "admin.html";

      // Socket
      const socket = io(SOCKET_URL);

      // State
      let currentSessionCode = null;
      let allQuestions = []; // Cache for stats

      // --- INITIALIZATION ---
      loadSessions();

      /* ========================
     SESSION MANAGEMENT
  ======================== */
      async function loadSessions() {
        try {
          const res = await fetch(`${API_URL}/sessions`);
          const data = await res.json();
          const list = document.getElementById("sessionList");
          list.innerHTML = "";

          // Update Stats
          document.getElementById("statSessions").innerText =
            data.data.length || 0;

          data.data.forEach((s) => {
            const div = document.createElement("div");
            div.className = `session-item ${s.status === "ACTIVE" ? "active" : ""}`;
            div.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div style="font-weight:bold; font-size:1rem;">${s.title}</div>
            <span class="badge ${s.status}">${s.status}</span>
          </div>
          <div style="font-size:0.85rem; color:#666; margin-bottom:12px;">Code: <strong>${s.sessionCode}</strong></div>
          
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
            <button class="btn-grey" onclick="openQManager('${s.sessionCode}')">Manage</button>
            ${
              s.status === "WAITING" || s.status === "COMPLETED"
                ? `<button class="btn-green" onclick="startSession('${s._id}', '${s.sessionCode}')">Start</button>`
                : `<button class="btn-red" onclick="stopSession('${s._id}')">Stop</button>`
            }
          </div>
        `;
            list.appendChild(div);
          });
        } catch (e) {
          console.error(e);
          document.getElementById("sessionList").innerHTML =
            "<p style='color:red; text-align:center'>Server Error</p>";
        }
      }

      async function createSession() {
        const title = document.getElementById("cTitle").value.trim();
        const code = document
          .getElementById("cCode")
          .value.trim()
          .toUpperCase();
        if (!title || !code) return alert("Fill all fields");

        await fetch(`${API_URL}/sessions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ title, sessionCode: code }),
        });

        document.getElementById("cTitle").value = "";
        document.getElementById("cCode").value = "";
        loadSessions();
      }

      async function startSession(id, code) {
        if (!confirm(`Start Session ${code}? Players can now see questions.`))
          return;

        // 1. Update DB Status
        await fetch(`${API_URL}/sessions/${id}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ status: "ACTIVE" }),
        });

        // 2. Emit Socket Event (Wakes up phones)
        socket.emit("admin:start_game", code);

        // 3. Open Leaderboard in new tab
        sessionStorage.setItem("SESSION_CODE", code);
        window.open("leaderboard.html", "_blank");

        loadSessions();
      }

      async function stopSession(id) {
        if (!confirm("Stop Session?")) return;
        await fetch(`${API_URL}/sessions/${id}/status`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({ status: "COMPLETED" }),
        });
        loadSessions();
      }

      /* ========================
     QUESTION MANAGEMENT
  ======================== */
      function openQManager(code) {
        currentSessionCode = code;
        document.getElementById("managerPlaceholder").style.display = "none";
        document.getElementById("qManager").style.display = "block";
        document.getElementById("targetCodeDisplay").innerText = code;

        // Reset inputs
        document.getElementById("qText").value = "";
        document.getElementById("optionsContainer").innerHTML = "";
        addOptionUI("", true);
        addOptionUI("", false);

        fetchQuestions(code);
      }

      function closeManager() {
        document.getElementById("qManager").style.display = "none";
        document.getElementById("managerPlaceholder").style.display = "block";
      }

      async function fetchQuestions(code) {
        const container = document.getElementById("existingQuestions");
        container.innerHTML = "Loading...";

        const res = await fetch(`${API_URL}/questions/session/${code}`);
        const data = await res.json();

        // Update Stats
        document.getElementById("statQuestions").innerText =
          data.data.length || 0;

        if (!data.data || data.data.length === 0) {
          container.innerHTML =
            "<p style='text-align:center; color:#999'>No questions yet.</p>";
          return;
        }

        container.innerHTML = data.data
          .map(
            (q, i) => `
      <div class="question-box">
        <div style="display:flex; justify-content:space-between;">
          <strong>Q${i + 1}: ${q.questionText}</strong>
          <button class="btn-red" style="padding:4px 8px; font-size:0.8rem;" onclick="deleteQuestion('${q._id}')">Delete</button>
        </div>
        <ul style="margin:10px 0 0 20px; font-size:0.9rem; color:#555;">
          ${q.options
            .map(
              (o) =>
                `<li style="${o.isCorrect ? "color:var(--google-green); font-weight:bold" : ""}">${o.text} ${o.isCorrect ? "âœ”" : ""}</li>`,
            )
            .join("")}
        </ul>
      </div>
    `,
          )
          .join("");
      }

      function addOptionUI(text = "", correct = false) {
        const div = document.createElement("div");
        div.className = "option-row";
        div.innerHTML = `
      <input type="radio" name="correctGroup" ${correct ? "checked" : ""} style="width:20px; margin:0;">
      <input class="opt-text" placeholder="Option text..." value="${text}" style="margin:0">
      <button class="btn-red" onclick="this.parentElement.remove()" style="padding:8px;">âœ•</button>
    `;
        document.getElementById("optionsContainer").appendChild(div);
      }

      async function saveQuestion() {
        const qText = document.getElementById("qText").value;
        const optRows = document.querySelectorAll(".option-row");
        const options = [];

        optRows.forEach((row) => {
          const text = row.querySelector(".opt-text").value;
          const isCorrect = row.querySelector("input[type=radio]").checked;
          if (text) options.push({ text, isCorrect });
        });

        if (!qText || options.length < 2)
          return alert("Question needs text and 2+ options");
        if (!options.some((o) => o.isCorrect))
          return alert("Select a correct answer");

        await fetch(`${API_URL}/questions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "admin-passcode": PASSCODE,
          },
          body: JSON.stringify({
            sessionId: currentSessionCode,
            questionText: qText,
            options: options,
            marks: 10,
          }),
        });

        // Refresh
        document.getElementById("qText").value = "";
        document.getElementById("optionsContainer").innerHTML = "";
        addOptionUI("", true);
        addOptionUI("", false);
        fetchQuestions(currentSessionCode);
      }

      async function deleteQuestion(id) {
        if (!confirm("Delete this question?")) return;
        await fetch(`${API_URL}/questions/${id}`, {
          method: "DELETE",
          headers: { "admin-passcode": PASSCODE },
        });
        fetchQuestions(currentSessionCode);
      }
    </script>
  </body>
</html>
